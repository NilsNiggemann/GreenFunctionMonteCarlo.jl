<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Advanced Usage · GreenFunctionMonteCarlo.jl</title><meta name="title" content="Advanced Usage · GreenFunctionMonteCarlo.jl"/><meta property="og:title" content="Advanced Usage · GreenFunctionMonteCarlo.jl"/><meta property="twitter:title" content="Advanced Usage · GreenFunctionMonteCarlo.jl"/><meta name="description" content="Documentation for GreenFunctionMonteCarlo.jl."/><meta property="og:description" content="Documentation for GreenFunctionMonteCarlo.jl."/><meta property="twitter:description" content="Documentation for GreenFunctionMonteCarlo.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">GreenFunctionMonteCarlo.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Overview</a></li><li><a class="tocitem" href="../Contents/">Contents</a></li><li><a class="tocitem" href="../Example_transverseFieldIsing/">Tutorial</a></li><li class="is-active"><a class="tocitem" href>Advanced Usage</a><ul class="internal"><li><a class="tocitem" href="#Accumulators"><span>Accumulators</span></a></li><li><a class="tocitem" href="#Saving-simulation-parameters"><span>Saving simulation parameters</span></a></li></ul></li><li><a class="tocitem" href="../Reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Advanced Usage</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Advanced Usage</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/NilsNiggemann/GreenFunctionMonteCarlo.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/NilsNiggemann/GreenFunctionMonteCarlo.jl/blob/master/docs/src/Advanced.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Advanced-Usage"><a class="docs-heading-anchor" href="#Advanced-Usage">Advanced Usage</a><a id="Advanced-Usage-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-Usage" title="Permalink"></a></h1><h2 id="Accumulators"><a class="docs-heading-anchor" href="#Accumulators">Accumulators</a><a id="Accumulators-1"></a><a class="docs-heading-anchor-permalink" href="#Accumulators" title="Permalink"></a></h2><p>For long- running simulations with many walkers, the amount of data generated can be substantial. The <code>ConfigSaver</code>, introduced in <a href="../Example_transverseFieldIsing/">Transverse Field Ising Model Example</a>, must store the configurations of <em>each</em> walker at <em>each</em> observation step, which can lead to high memory consumption. Typically, one is ultimately interested in the expectation values of a handful of observables, which may also be obtained by accumulating data on-the-fly during the simulation. GreenFunctionMonteCarlo.jl provides a <a href="../Reference/#GreenFunctionMonteCarlo.BasicAccumulator"><code>BasicAccumulator</code></a> which stores the energy and some additional data required for other accumulators, as well as an  <a href="../Reference/#GreenFunctionMonteCarlo.ObservableAccumulator"><code>ObservableAccumulator</code></a> which can be used to accumulate arbitrary observables defined as subtypes of <code>AbstractObservable</code>.</p><p>In summary, the advantages of accumulators are:</p><ul><li><strong>Reduced Storage Usage</strong></li></ul><p>The drawbacks are:</p><ul><li><strong>Limited Post-Processing Flexibility</strong>: The observables cannot be obtained from post-processing. The maximum projection time needs to be defined before the simulation.</li><li><strong>Increased memory usage</strong>: To avoid costly recomputation of expensive obersvables for the same configurations, accumulators use buffers to store the observables for the last couple of iterations to do the projection. The memory size required is given by <code>NObs* NWalkers * N_projection_steps*size(data_type)</code>. It can be advisable to use a more efficient <code>data_type</code> for the buffer, such as <code>Float32</code>. For example, accumulating the local magnetization for <em>N_sites</em>, the memory usage will be</li></ul><pre><code class="language-julia hljs">N_sites = 500
N_obs = N_sites
NWalkers = 5000
m_proj = 150
Base.format_bytes(Base.summarysize(zeros(Float32, N_obs))* NWalkers * m_proj)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">&quot;1.425 GiB&quot;</code></pre><ul><li><strong>Possible Numerical Instabilities</strong>: Accumulating data on-the-fly can introduce numerical instabilities, especially when the estimated average weight of the walkers is not accurate (in which case at each step, some very large and very small numbers are added to numerator and denominator). It is advisable to initialize the <code>ContinuousTimePropagator</code> with a reasonable estimate of the ground state energy to mitigate this issue. Below, it is shown how to do that. Another strategy is to use more than one bin for the accumulation, so that not too many numbers are added up to the same storage.</li></ul><h3 id="Example-run"><a class="docs-heading-anchor" href="#Example-run">Example run</a><a id="Example-run-1"></a><a class="docs-heading-anchor-permalink" href="#Example-run" title="Permalink"></a></h3><p>We first run a simulation without measuring observables to estimate the average weight of the walkers. It can be used as a replacement for equilibrating the walkers with a first <code>runGFMC!</code> call. With each epoch, the estimate will be a bit better, but typically not very many should be required.</p><pre><code class="language-julia hljs">problem = GFMCProblem(startConfig, NWalkers, ContinuousTimePropagator(dtau); logψ, H, Hilbert)
mean_TotalWeights, w_avg_estimate = GFMC.estimate_weights_continuousTime!(problem;Nepochs=4,Nsamples=400,verbose=true,logger = nothing)</code></pre><p>The <code>BasicAccumulator</code> stores running sums of the numerator and the denominator for the energy. It also provides internal buffers which are used for the reconfiguration process. In order to measure other observables, one can use the <code>ObservableAccumulator</code>, which holds a reference to the <code>BasicAccumulator</code> to access the internal buffers. Here, we measure the local magnetization and the density-density correlation function as an example.</p><p>The set of observables is packed as a tuple into a <code>CombinedObserver</code>, which makes sure that each observable is updated at each observation step.</p><pre><code class="language-julia hljs">outfile = &quot;observables.h5&quot;
num_bins = 32 # number of bins for the accumulation
BAcc = BasicAccumulator(outfile,m_proj, NWalkers;weight_normalization = mean_TotalWeights, num_bins = num_bins , bin_elements = NSteps_total ÷ num_bins)

OccNum_Acc = ObservableAccumulator(outfile,OccupationNumber(Nsites),BAcc, mProj, NWalkers, Threads.nthreads())

Observer = CombinedObserver((BAcc, OccNum_Acc, )) # note the tuple. Include more observable accumulators as needed

CT = ContinuousTimePropagator(dtau, w_avg_estimate) # use the estimated average weight here
runGFMC!(problem, Observer, NSteps_total; Propagator = CT) # we may override the propagator from &quot;problem&quot; by passing a different one as a keyword argument</code></pre><h3 id="Example-evaluation"><a class="docs-heading-anchor" href="#Example-evaluation">Example evaluation</a><a id="Example-evaluation-1"></a><a class="docs-heading-anchor-permalink" href="#Example-evaluation" title="Permalink"></a></h3><p>After the simulation, the accumulated data can be accessed from the HDF5 file. We still need to do some post-processing, such as averaging over the bins. This is not done automatically in the previous step, because the binning may also be used to estimate error bars, provided that the simulation is long enough to decorrelate the bins.</p><pre><code class="language-julia hljs"># read the data from the HDF5 file and pack the numerators and denominators into tuples that mock the structure of the accumulators.
# Note: If the accumulators themselves are still in memory, we can of course also use them instead.
function readObs(file,bunching)
    BasicAccMock = (;en_numerator = h5read(file, &quot;en_numerator&quot;),Gnp_denominator = h5read(file, &quot;Gnp_denominator&quot;))

    Energy = GFMC.get_energy_from_accumulator_bunching(BasicAccMock, bunching)

    OccNumMock = (;Obs_numerators = h5read(file, &quot;OccupationNumber_numerator&quot;),
    Obs_denominators = h5read(file, &quot;OccupationNumber_denominator&quot;))
    OccupationNumbers = GFMC.get_obs_from_accumulator_bunching(OccNumMock, bunching)

    Obs = (;Energy, OccupationNumbers)
    return Obs
end</code></pre><p>If we call the function with <code>bunching = 8</code>, the following will happen:</p><ul><li>Numerators and denominators will be normalized to avoid numerical instabilities when adding up many numbers.</li><li>Numerators and denominators of each 8 bins will be added up.</li><li>We will divide the summed numerators by the summed denominators to obtain the final expectation values.</li><li>Since there were <code>num_bins = 32</code> bins in total, we will obtain 4 data points for each observable, which can be used to estimate error bars.</li></ul><div class="admonition is-warning" id="Warning-341073cb15a0c3c3"><header class="admonition-header">Warning<a class="admonition-anchor" href="#Warning-341073cb15a0c3c3" title="Permalink"></a></header><div class="admonition-body"><p>To estimate error bars, you must ensure that the bins are sufficiently decorrelated. This typically requires long simulations.</p></div></div><h2 id="Saving-simulation-parameters"><a class="docs-heading-anchor" href="#Saving-simulation-parameters">Saving simulation parameters</a><a id="Saving-simulation-parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Saving-simulation-parameters" title="Permalink"></a></h2><p>To store parameters of the simulation, such as model parameters, number of walkers, time step, etc., GreenFunctionMonteCarlo.jl provides a function <code>save_params_dict</code>, which saves a dictionary of key-value pairs to an HDF5 file. This can be useful for keeping track of the simulation settings alongside the results. Nested dicts are also supported and will be stored as HDF5 groups.</p><pre><code class="language-julia hljs">using GreenFunctionMonteCarlo
using GreenFunctionMonteCarlo.HDF5
params = Dict(
    &quot;mProj&quot; =&gt; 5,
    &quot;misc&quot; =&gt; Dict(:a =&gt; 1, :b =&gt; 2.0, :c =&gt; &quot;test&quot;),
    &quot;NSteps_total&quot; =&gt; 55,
    &quot;mean_TotalWeights&quot; =&gt; 55.,
    &quot;configs&quot; =&gt; zeros(Int8,3,2),
)
outfile = tempname()
save_params_dict(outfile, Dict(&quot;params&quot; =&gt; params), mode=&quot;w&quot;)
h5open(outfile, &quot;r&quot;) do f
    println(read(f))
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict{String, Any}(&quot;params&quot; =&gt; Dict{String, Any}(&quot;mean_TotalWeights&quot; =&gt; 55.0, &quot;mProj&quot; =&gt; 5, &quot;misc&quot; =&gt; Dict{String, Any}(&quot;c&quot; =&gt; &quot;test&quot;, &quot;b&quot; =&gt; 2.0, &quot;a&quot; =&gt; 1), &quot;configs&quot; =&gt; Int8[0 0; 0 0; 0 0], &quot;NSteps_total&quot; =&gt; 55))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Example_transverseFieldIsing/">« Tutorial</a><a class="docs-footer-nextpage" href="../Reference/">Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Tuesday 21 October 2025 12:10">Tuesday 21 October 2025</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
